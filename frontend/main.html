<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OSM + Satellite Map with Hover Marker (HR demo)</title>
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
    .leaflet-tooltip.hr-tooltip {
      background: rgba(0,0,0,0.8);
      color: #fff;
      border: 0;
      box-shadow: 0 4px 16px rgba(0,0,0,0.25);
      border-radius: 8px;
      padding: 8px 10px;
      font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    .legend {
      position: absolute;
      right: 12px;
      bottom: 12px;
      background: rgba(255,255,255,0.9);
      border-radius: 10px;
      padding: 8px 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      font: 13px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial;
    }
    .legend small { color: #555; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="legend">
    <b>Layers:</b> OSM & ESRI World Imagery<br />
    <small>Note: "Galileo" is a GNSS and "Cassini" was a Saturn mission; for Earth satellite basemaps we use public imagery services (here ESRI World Imagery).</small>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script>
    // --- Configurable hard-coded demo point (later replace via AJAX) ---
    const demoData = {
      name: "Runner #12",
      lat: 42.6977, // Sofia
      lon: 23.3219,
      hr: 128
    };

    // Format helpers
    const fmt = (n, d=5) => Number(n).toFixed(d);

    // Base layers
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    // ESRI World Imagery (satellite)
    const esriSat = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      {
        maxZoom: 19,
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
      }
    );

    // Map
    const map = L.map('map', {
      center: [demoData.lat, demoData.lon],
      zoom: 13,
      layers: [osm] // default layer
    });

    // Layer control
    L.control.layers({ "OpenStreetMap": osm, "Satellite": esriSat }, null, { collapsed: false }).addTo(map);

    // Marker with hover tooltip
    const marker = L.marker([demoData.lat, demoData.lon]).addTo(map);

    function tooltipHTML(d) {
      return `
        <div>
          <div><b>${d.name}</b></div>
          <div>Lat: ${fmt(d.lat)}, Lon: ${fmt(d.lon)}</div>
          <div>HR: ${d.hr} bpm</div>
        </div>`;
    }

    marker.bindTooltip(tooltipHTML(demoData), {
      direction: 'top',
      sticky: true,
      opacity: 0.95,
      className: 'hr-tooltip'
    });

    // Optional: show tooltip on hover immediately
    marker.on('mouseover', () => marker.openTooltip());
    marker.on('mouseout',  () => marker.closeTooltip());

    // --- Future: simple hook to update from AJAX ---
    // Call setData(newData) after fetching from your endpoint
    function setData(d) {
      // Update position
      marker.setLatLng([d.lat, d.lon]);
      // Update tooltip content
      marker.setTooltipContent(tooltipHTML(d));
    }

    // Example of how you might fetch later:
    // async function fetchAndUpdate() {
    //   const r = await fetch('/api/telemetry/latest');
    //   const json = await r.json();
    //   setData({
    //     name: json.name,
    //     lat: json.lat,
    //     lon: json.lon,
    //     hr: json.hr
    //   });
    // }
    // setInterval(fetchAndUpdate, 5000);
  </script>
</body>
</html>
